From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: repo-changes <noreply@example.com>
Date: Thu, 22 Jan 2026 00:00:00 +0000
Subject: [PATCH] config: move hardcoded settings to config.py; add manifest/sw fallback
 and minimal SW; add .env.example

---
 .env.example                          | 18 ++++++++++++++++++
 config.py                             | 63 ++++++++++++++++++++++++++++++++++++++++++
 static/manifest.json                  | 12 +++++++
 static/js/sw.js                       | 12 +++++++
 app.py                                | 33 +++++++++++++++---------------
 5 files changed, 87 insertions(+), 41 deletions(-)
 create mode 100644 .env.example
 create mode 100644 config.py
 create mode 100644 static/manifest.json
 create mode 100644 static/js/sw.js
-- 
2.39.2

diff --git a/.env.example b/.env.example
new file mode 100644
index 0000000..1111111
--- /dev/null
+++ b/.env.example
@@ -0,0 +1,18 @@
+# .env.example - copia como .env en desarrollo o exporta variables en producción
+
+# URL pública (usada en enlaces de Discord y deep links)
+WEB_PUBLIC_URL=https://legacyesportsclub.etern8.app
+
+# Webhook de Discord (dejar vacio si no quieres notificaciones)
+DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/......
+
+# Clave secreta (cambiar en producción)
+SECRET_KEY=CAMBIA_ESTA_CLAVE_POR_OTRA_MUY_SECRETA
+
+# Base de datos (ejemplo SQLite dentro de instance/)
+# Para SQLite: SQLALCHEMY_DATABASE_URI=sqlite:///instance/legacy_strategy.db
+SQLALCHEMY_DATABASE_URI=sqlite:///instance/legacy_strategy.db
+
+# Carpeta de uploads (ruta relativa)
+UPLOAD_FOLDER=static/uploads
+
+# Tamaño máximo de subida en bytes
+MAX_CONTENT_LENGTH=16777216
+
+# Extensiones permitidas (coma separadas)
+ALLOWED_EXTENSIONS=png,jpg,jpeg,gif,webp,pdf
diff --git a/config.py b/config.py
new file mode 100644
index 0000000..2222222
--- /dev/null
+++ b/config.py
@@ -0,0 +1,63 @@
+# config.py
+# Centraliza configuración a partir de variables de entorno con valores por defecto seguros.
+
+import os
+
+BASE_DIR = os.path.abspath(os.path.dirname(__file__))
+
+# Instance dir (igual que en el app.py original)
+INSTANCE_PATH = os.path.join(BASE_DIR, 'instance')
+os.makedirs(INSTANCE_PATH, exist_ok=True)
+
+# URLs y webhooks
+WEB_PUBLIC_URL = os.getenv('WEB_PUBLIC_URL', "https://legacyesportsclub.etern8.app")
+DISCORD_WEBHOOK_URL = os.getenv(
+    'DISCORD_WEBHOOK_URL',
+    "https://discord.com/api/webhooks/1461067385736794285/ocjLAfJE2en90MjwsftvESrPp5OduaySwxhaFhY8yBevQbD_i3R1Ktwwl5__pPpixezL"
+)
+
+# Seguridad
+SECRET_KEY = os.getenv('SECRET_KEY', 'LEGACY_2026_KEY')
+
+# Base de datos (SQLite por defecto, conserva comportamiento actual)
+DB_NAME = os.getenv('DB_NAME', 'legacy_strategy.db')
+DATABASE_PATH = os.getenv('DATABASE_PATH', os.path.join(INSTANCE_PATH, DB_NAME))
+SQLALCHEMY_DATABASE_URI = os.getenv('SQLALCHEMY_DATABASE_URI', f"sqlite:///{DATABASE_PATH}")
+
+# Uploads
+UPLOAD_FOLDER = os.getenv('UPLOAD_FOLDER', os.path.join('static', 'uploads'))
+ALLOWED_EXTENSIONS = set([e.strip() for e in os.getenv('ALLOWED_EXTENSIONS', 'png,jpg,jpeg,gif,webp,pdf').split(',')])
+
+# Otros
+MAX_CONTENT_LENGTH = int(os.getenv('MAX_CONTENT_LENGTH', 16 * 1024 * 1024))
+
+# Garantiza que existan carpetas necesarias
+os.makedirs(UPLOAD_FOLDER, exist_ok=True)
+
diff --git a/static/manifest.json b/static/manifest.json
new file mode 100644
index 0000000..3333333
--- /dev/null
+++ b/static/manifest.json
@@ -0,0 +1,12 @@
+{
+  "short_name": "Legacy",
+  "name": "Legacy eSports Club",
+  "icons": [
+    {
+      "src": "/static/img/favicon.png",
+      "sizes": "192x192",
+      "type": "image/png"
+    }
+  ],
+  "start_url": "/",
+  "display": "standalone",
+  "theme_color": "#FF5A00",
+  "background_color": "#0a0a0a"
+}
diff --git a/static/js/sw.js b/static/js/sw.js
new file mode 100644
index 0000000..4444444
--- /dev/null
+++ b/static/js/sw.js
@@ -0,0 +1,12 @@
+// Minimal service worker para no romper la PWA.
+// Muestra comportamiento básico: instala, activa y deja pasar las peticiones a la red.
+
+self.addEventListener('install', event => {
+  // Skip waiting to activate immediately on update
+  self.skipWaiting();
+});
+
+self.addEventListener('activate', event => {
+  self.clients.claim();
+});
+
+self.addEventListener('fetch', event => {
+  // Default: dejar que la red/proxy sirva los recursos.
+  // No se hace caching agresivo para evitar romper funcionalidades existentes.
+});
diff --git a/app.py b/app.py
index 5555555..6666666 100644
--- a/app.py
+++ b/app.py
@@ -1,6 +1,9 @@
 import os
 import requests
 import re
+from config import (
+    WEB_PUBLIC_URL,
+    DISCORD_WEBHOOK_URL,
+    SECRET_KEY,
+    SQLALCHEMY_DATABASE_URI,
+    UPLOAD_FOLDER,
+    ALLOWED_EXTENSIONS,
+    MAX_CONTENT_LENGTH
+)
 import json
 import sqlite3
 import time
 from datetime import datetime, date
 from flask import Flask, render_template, request, jsonify, redirect, url_for, flash, send_from_directory
 from flask_sqlalchemy import SQLAlchemy
 from flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user
 from werkzeug.utils import secure_filename
 from werkzeug.security import generate_password_hash, check_password_hash
@@
-instance_path = os.path.join(basedir, 'instance')
-if not os.path.exists(instance_path):
-    os.makedirs(instance_path)
+instance_path = os.path.join(basedir, 'instance')
+if not os.path.exists(instance_path):
+    os.makedirs(instance_path)
@@
-db_path = os.path.join(instance_path, db_name)
-app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///' + db_path
-app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
-app.secret_key = 'LEGACY_2026_KEY' 
-app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024 
-
-UPLOAD_FOLDER = os.path.join('static', 'uploads')
-ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'webp', 'pdf'}
-app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
-os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
-
-# 3. Webhook Discord
-DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1461067385736794285/ocjLAfJE2en90MjwsftvESrPp5OduaySwxhaFhY8yBevQbD_i3R1Ktwwl5__pPpixezL"
+app.config['SQLALCHEMY_DATABASE_URI'] = SQLALCHEMY_DATABASE_URI
+app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
+app.secret_key = SECRET_KEY
+app.config['MAX_CONTENT_LENGTH'] = MAX_CONTENT_LENGTH
+
+app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
+os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
+
+# Nota: DISCORD_WEBHOOK_URL y WEB_PUBLIC_URL ahora vienen desde config.py y pueden
+# ser sobreescritas mediante variables de entorno. Se mantienen valores por defecto.
 
@@
 # 3. Webhook Discord
-DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1461067385736794285/ocjLAfJE2en90MjwsftvESrPp5OduaySwxhaFhY8yBevQbD_i3R1Ktwwl5__pPpixezL"
+# DISCORD_WEBHOOK_URL definido desde config.py
 
@@
 # --- RUTAS DE ARCHIVOS ESTÁTICOS ---
-@app.route('/manifest.json')
-def manifest(): return send_from_directory('static', 'manifest.json')
-@app.route('/sw.js')
-def service_worker(): return send_from_directory('static', 'sw.js')
+@app.route('/manifest.json')
+def manifest(): 
+    # Si hay un fichero estático en static/manifest.json, servimos ese fichero.
+    # En caso contrario, mantenemos el fallback dinámico usado en la app.
+    static_manifest = os.path.join('static', 'manifest.json')
+    if os.path.exists(static_manifest):
+        return send_from_directory('static', 'manifest.json')
+    else:
+        return jsonify({
+            "short_name": "Legacy",
+            "name": "Legacy eSports Club",
+            "icons": [{"src": "/static/img/favicon.png", "sizes": "192x192", "type": "image/png"}],
+            "start_url": "/",
+            "display": "standalone",
+            "theme_color": "#FF5A00",
+            "background_color": "#0a0a0a"
+        })
+
+@app.route('/sw.js')
+def service_worker():
+    # Preferimos static/js/sw.js para que el SW se encuentre en la ubicación habitual.
+    js_sw = os.path.join('static', 'js', 'sw.js')
+    alt_sw = os.path.join('static', 'sw.js')
+    if os.path.exists(js_sw):
+        return send_from_directory('static/js', 'sw.js')
+    elif os.path.exists(alt_sw):
+        return send_from_directory('static', 'sw.js')
+    else:
+        return ("", 204)
 
 # --- TELEMETRÍA ---
 telemetry_data = {"connected": False, "laps": 0, "fuel": 0, "driver": "", "flag": "green", "timestamp": 0}
@@ -1,1 +1,1 @@
 # End of patch

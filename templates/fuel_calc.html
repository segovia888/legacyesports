<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Legacy eSports Club · Fuel Calc</title>
  
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.png') }}">
<link rel="manifest" href="{{ url_for('manifest') }}">
  <meta name="theme-color" content="#FF5A00">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register("{{ url_for('service_worker') }}")
        .then(reg => console.log('SW registrado: ', reg.scope))
        .catch(err => console.log('SW error: ', err));
      });
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&family=Teko:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    /* --- VARIABLES LEGACY --- */
    :root {
        --lec-orange: #FF5A00;
        --lec-lime: #CCFF00;
        --carbon: #0a0a0a;
        --glass: rgba(20, 20, 20, 0.85);
        --glass-light: rgba(255, 255, 255, 0.05);
        --border: rgba(255, 255, 255, 0.15);
        --text-main: #e8eaed;
        --text-muted: #9aa3ad;
    }

    * { box-sizing: border-box; }

    body {
        margin: 0;
        font-family: 'Roboto', sans-serif;
        background-color: var(--carbon);
        color: var(--text-main);
        font-size: 16px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    /* --- FONDO --- */
    .bg-container {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1;
        background: url("{{ url_for('static', filename='img/legacy-card-bg.jpg') }}") no-repeat center center/cover;
    }
    .bg-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.95) 100%);
    }

    /* --- HEADER --- */
    .top-bar {
        padding: 20px 40px;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(5px);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
    }

    .brand {
        font-family: 'Teko', sans-serif;
        font-size: 2rem;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 10px;
        color: white;
    }
    
    .brand .section { color: var(--lec-orange); }

    /* --- LAYOUT PRINCIPAL --- */
    .wrap {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 20px;
        width: 100%;
        z-index: 2;
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
    }

    /* --- TARJETAS --- */
    .card {
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 25px;
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    h2 {
        font-family: 'Teko', sans-serif;
        font-size: 1.8rem;
        text-transform: uppercase;
        color: var(--lec-lime);
        margin-top: 0;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 10px;
    }

    /* --- INPUTS Y FORMULARIOS --- */
    label {
        font-size: 0.85rem;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 5px;
        display: block;
        letter-spacing: 0.5px;
    }

    input, select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        font-family: 'Roboto', sans-serif;
        font-size: 1rem;
        transition: all 0.2s;
    }

    input:focus, select:focus {
        outline: none;
        border-color: var(--lec-lime);
        background: black;
        box-shadow: 0 0 8px rgba(204, 255, 0, 0.2);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        align-items: end;
    }

    /* --- KPIs (CAJAS DE RESULTADOS) --- */
    .kpi {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .kpi .box {
        flex: 1;
        min-width: 180px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: linear-gradient(180deg, rgba(255, 90, 0, 0.05), rgba(204, 255, 0, 0.02));
        padding: 15px;
        text-align: center;
    }

    .kpi .box div:first-child { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; }
    .kpi .val {
        font-family: 'Teko', sans-serif;
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        line-height: 1;
        margin-top: 5px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    #kpiAdd { color: var(--lec-orange); }
    #kpiWheels { color: var(--lec-lime); }

    /* --- TABLAS --- */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 1rem; }
    th { 
        text-align: left; padding: 12px; 
        color: var(--lec-orange); 
        font-family: 'Teko', sans-serif; font-size: 1.2rem; font-weight: 400; text-transform: uppercase;
        border-bottom: 2px solid var(--border);
    }
    td { padding: 12px; border-bottom: 1px solid var(--border); color: #ddd; }
    tbody tr:nth-child(odd) { background: rgba(255,255,255,0.03); }
    
    .pit-summary {
        margin-top: 15px;
        font-family: 'Roboto', sans-serif;
        color: var(--lec-lime);
        font-weight: 500;
        padding: 10px;
        background: rgba(204, 255, 0, 0.05);
        border-radius: 6px;
        border-left: 3px solid var(--lec-lime);
    }

    /* --- BOTONES --- */
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    
    .btn {
        border: 1px solid var(--lec-lime);
        border-radius: 6px;
        padding: 10px 20px;
        background: transparent;
        color: var(--lec-lime);
        cursor: pointer;
        font-family: 'Teko', sans-serif;
        font-size: 1.2rem;
        text-transform: uppercase;
        text-decoration: none;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn:hover {
        background: var(--lec-lime);
        color: black;
        box-shadow: 0 0 15px rgba(204, 255, 0, 0.4);
    }

    .btn.primary {
        background: var(--lec-orange);
        border-color: var(--lec-orange);
        color: white;
    }
    .btn.primary:hover {
        background: #ff7b00;
        color: white;
        box-shadow: 0 0 15px rgba(255, 90, 0, 0.4);
    }

    .btn.secondary {
        border-color: var(--border);
        color: var(--text-muted);
    }
    .btn.secondary:hover {
        border-color: white;
        color: white;
        background: rgba(255,255,255,0.1);
        box-shadow: none;
    }

    /* --- PRESETS & JSON --- */
    .presets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
        margin-bottom: 15px;
    }
    
    .json-buttons {
        display: flex; gap: 10px; align-items: center; justify-content: center; margin-top: 10px;
    }
    
    .btn.json-btn, label.btn.json-btn { 
        min-width: 160px; font-size: 1rem; height: 40px; 
    }
    label.btn.json-btn input { display: none; }

    #savedList { margin-top: 15px; color: var(--text-muted); font-size: 0.9rem; }
    
    .saved-item {
        background: rgba(0,0,0,0.3) !important;
        border: 1px solid var(--border) !important;
    }

    footer {
        text-align: center; margin-top: auto; padding: 30px; 
        color: var(--text-muted); font-size: 0.8rem; z-index: 10;
    }
  </style>
</head>
<body>

  <div class="bg-container"><div class="bg-overlay"></div></div>

  <div class="top-bar">
    <div class="brand">
        <i class="fas fa-gas-pump" style="color:var(--lec-lime); font-size: 1.5rem;"></i>
        Legacy <span class="section">Fuel Calc</span>
    </div>
    <div class="actions">
      <a href="{{ url_for('index') }}" class="btn secondary"><i class="fas fa-arrow-left"></i> Volver</a>
      <button id="btnSave" class="btn"><i class="fas fa-save"></i> Guardar</button>
      <button id="btnCalc" class="btn primary"><i class="fas fa-calculator"></i> Calcular</button>
    </div>
  </div>

  <div class="wrap">
    
    <section class="card">
      <h2><i class="fas fa-tachometer-alt"></i> Telemetría de Carrera</h2>
      <div class="kpi">
        <div class="box"><div>Vueltas Totales</div><div id="kpiLaps" class="val">—</div></div>
        <div class="box"><div>Salida (L)</div><div id="kpiStart" class="val">—</div></div>
        <div class="box"><div>Repostaje (L)</div><div id="kpiAdd" class="val">—</div></div>
        <div class="box"><div>Ruedas “Gratis”</div><div id="kpiWheels" class="val">—</div></div>
      </div>
      <div id="kpiTotalLine" style="margin:-10px 0 15px 5px; font-weight:bold; color: var(--text-muted);"></div>
      
      <table>
        <thead><tr><th># Stint</th><th>Vueltas</th><th>Repostaje (L)</th><th>Notas</th></tr></thead>
        <tbody id="stintsBody"><tr><td colspan="4" style="text-align:center; padding: 20px; color: var(--text-muted);">Pulsa Calcular para generar la estrategia.</td></tr></tbody>
      </table>
      <div id="pitSummary" class="pit-summary" style="margin-top:20px"></div>
    </section>

    <section class="card">
      <h2><i class="fas fa-sliders-h"></i> Configuración</h2>
      <div class="form-grid">
        <div><label>Nombre Carrera</label><input id="raceName" placeholder="Ej. Spa 24h"></div>
        <div><label>Modo</label><select id="mode"><option value="time">Por tiempo (min)</option><option value="laps">Por vueltas</option></select></div>
        <div><label>Duración (min)</label><input id="duration" type="number" value="45"></div>
        <div><label>Lap Time (mm:ss.mmm)</label><input id="laptime" value="1:48.500"></div>
        <div><label>Consumo (L/v)</label><input id="consumption" type="number" step="0.01" value="2.6"></div>
        <div><label>Capacidad (L)</label><input id="tank" type="number" value="100"></div>
        <div><label>Fuel Salida (L)</label><input id="startFuel" type="number" placeholder="Opcional"></div>
        <div><label>Vueltas Seguridad</label><input id="safetyLaps" type="number" value="1"></div>
        <div><label>Vuelta Formación</label><select id="formation"><option value="none">Sin formación</option><option value="full">Completa</option><option value="short">Corta</option></select></div>
        <div><label>Consumo Form. (L)</label><input id="formationFuel" type="number" value="0"></div>
      </div>
    </section>

    <section class="card">
      <h2><i class="fas fa-car"></i> Presets de Coche</h2>
      <div class="presets-grid">
        <div>
            <label>Nombre Preset</label>
            <input id="presetName" list="carListDB" placeholder="Selecciona o escribe..." autocomplete="off">
            <datalist id="carListDB">
                {% for c in cars %}
                <option value="{{ c.name }}">{{ c.category }}</option>
                {% endfor %}
            </datalist>
        </div>
        <div><label>Guardados</label><select id="presetSelect"></select></div>
        <div><label>Tiempo Llenado (s)</label><input id="fillTime" type="number" value="20"></div>
        <div><label>Cambio Ruedas (s)</label><input id="wheelTime" type="number" value="24"></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="btnPresetSave" class="btn secondary" style="font-size: 1rem;">Guardar Preset</button>
        <button id="btnPresetApply" class="btn secondary" style="font-size: 1rem;">Aplicar</button>
        <button id="btnPresetDelete" class="btn secondary" style="font-size: 1rem; border-color: #ff4444; color: #ff4444;">Borrar</button>
      </div>
    </section>

    <section class="card">
      <h2><i class="fas fa-save"></i> Datos Locales</h2>
      <div class="json-buttons">
        <button id="btnExportJSON" class="btn json-btn secondary"><i class="fas fa-file-export"></i> Exportar JSON</button>
        <label class="btn json-btn secondary"><i class="fas fa-file-import"></i> Importar JSON<input id="importJSON" type="file" accept="application/json" /></label>
      </div>
      <div id="savedList">No hay estrategias guardadas.</div>
    </section>

  </div>

  <footer>© Legacy eSports Club · Fuel Calculator · Powered by Legacy Engineering</footer>

  <script>
  (function(){
    // ====== Helpers ======
    const $ = s => document.querySelector(s);
    const LS_STRATEGIES='legacy_fuel_strategies_v1';
    const LS_PRESETS='legacy_fuel_presets_v1';

    function parseLapTime(str){
      const m=String(str||'').trim().match(/^(\d+):(\d{1,2})(?:\.(\d{1,3}))?$/);
      if(!m) return NaN; return (+m[1])*60 + (+m[2]) + ((+m[3]||0))/1000;
    }
    function toNum(v,def=0){ const n=+v; return Number.isFinite(n)?n:def; }
    function loadJSON(key,def){ try{return JSON.parse(localStorage.getItem(key)||JSON.stringify(def));}catch{ return def; } }
    function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

    let lastStints=null; // para guardar

    // ====== Cálculo principal ======
    function compute(){
      const lapTime=parseLapTime($('#laptime').value);
      if(!isFinite(lapTime)){ alert('Lap time inválido (mm:ss.mmm)'); return; }
      const mode=$('#mode').value;
      const duration=toNum($('#duration').value,0);
      const L_per_lap=toNum($('#consumption').value,0);
      const tank=toNum($('#tank').value,0);
      let startFuel=toNum($('#startFuel').value, NaN);
      if(!(startFuel>0)) startFuel=tank; startFuel=Math.max(0, Math.min(startFuel, tank));
      const safetyLaps=toNum($('#safetyLaps').value,0);
      const formation=$('#formation').value;
      const formationFuel=toNum($('#formationFuel').value,0);

      const lapsPlanned=(mode==='time')?Math.floor((duration*60)/lapTime):Math.max(0,Math.floor(duration));
      const extraFormationLaps=(formation==='full')?1:(formation==='short'?0.5:0);

      const baseFuel=lapsPlanned*L_per_lap;
      const safetyFuel=safetyLaps*L_per_lap;
      const auxFuel=(extraFormationLaps*L_per_lap)+formationFuel;
      const totalFuel=baseFuel+safetyFuel+auxFuel;
      const usableTank=tank;
      const maxLapsPerFull=L_per_lap>0?Math.floor(usableTank/L_per_lap):0;

      $('#kpiLaps').textContent=(lapsPlanned+extraFormationLaps).toFixed(1);
      $('#kpiStart').textContent=startFuel.toFixed(1)+' L';
      $('#kpiTotalLine').textContent=`Total requerido: ${totalFuel.toFixed(1)} L (tanque utilizable ${usableTank.toFixed(1)} L)`;

      if(L_per_lap<=0||maxLapsPerFull<=0){
        $('#stintsBody').innerHTML='<tr><td colspan="4" class="muted">Parámetros inválidos.</td></tr>';
        $('#kpiAdd').textContent='—'; $('#pitSummary').textContent='';
        lastStints=null; return;
      }

      if(totalFuel<=startFuel){
        $('#kpiAdd').textContent='—';
        $('#stintsBody').innerHTML=`<tr><td>1</td><td>${lapsPlanned}</td><td>—</td><td class="muted">Sin paradas</td></tr>`;
        $('#pitSummary').textContent='Sin paradas necesarias.';
        lastStints=[{n:1,laps:lapsPlanned,refuel:0,note:'Sin paradas'}];
        $('#kpiWheels').textContent='—';
        return;
      }

      let lapsLeft=lapsPlanned;
      const stints=[];
      const stopLiters=[]; // solo paradas

      const maxLapsStart=Math.floor(startFuel/L_per_lap);
      let stintLaps=Math.min(maxLapsStart,lapsLeft);
      stints.push({n:1,laps:stintLaps,refuel:0,note:`Salida (${startFuel.toFixed(1)} L)`});
      lapsLeft-=stintLaps;
      let residual=startFuel-(stintLaps*L_per_lap);

      while(lapsLeft>0){
        const needWithSafety=(lapsLeft*L_per_lap)+safetyFuel;
        if(needWithSafety<=usableTank){
          const add=Math.max(0,Math.min(usableTank-residual,needWithSafety-residual));
          const lapsThis=lapsLeft;
          stints.push({n:stints.length+1,laps:lapsThis,refuel:add,note:'Último: necesario + seguridad'});
          stopLiters.push(add);
          lapsLeft=0;
        }else{
          const add=Math.max(0,usableTank-residual);
          const lapsThis=Math.min(maxLapsPerFull,lapsLeft);
          stints.push({n:stints.length+1,laps:lapsThis,refuel:add,note:'Llenar (a tope)'});
          stopLiters.push(add);
          residual=usableTank-(lapsThis*L_per_lap);
          lapsLeft-=lapsThis;
        }
      }

      // Render tabla
      $('#stintsBody').innerHTML=stints.map(s=>`<tr><td>${s.n}</td><td>${s.laps}</td><td>${s.refuel?s.refuel.toFixed(1):'—'}</td><td class="muted">${s.note}</td></tr>`).join('');

      // KPIs y resumen de paradas con ruedas “gratis”
      $('#kpiAdd').textContent=stopLiters.length?stopLiters.map(l=>l.toFixed(1)+'L').join(' + '):'—';

      const fillTime=toNum($('#fillTime').value,20); // s para tanque lleno (presets)
      const wheelTime=toNum($('#wheelTime').value,24); // s las 4 ruedas
      const perLiter = (tank>0)? fillTime / tank : 0;
      const perWheel = wheelTime / 4;

      const lines = stopLiters.map((lit,i)=>{
        const fuelSec = perLiter * lit;
        const wheelsFree = Math.floor(perWheel>0 ? fuelSec / perWheel : 0);
        const cap = Math.max(0, Math.min(4, wheelsFree));
        let extra = '';
        if(cap<4 && perWheel>0){
          const extra4 = Math.max(0, (4*perWheel) - fuelSec);
          extra = ` (4 ⇒ +${extra4.toFixed(1)} s)`;
        }
        return `#${i+1}: +${lit.toFixed(1)} L · ⏱️${fuelSec.toFixed(1)} s · ruedas “gratis” ${cap}/4${extra}`;
      });
      $('#pitSummary').textContent = lines.length? ('Paradas: '+lines.join('  ·  ')) : 'Sin paradas necesarias.';

      // KPI de ruedas (resumen corto)
      const best = lines.map(l=>l.match(/(\d)\/4/)).filter(Boolean).map(m=>+m[1]);
      $('#kpiWheels').textContent = best.length? `${Math.max(...best)}/4` : '—';

      lastStints=stints;
    }

    // ===== Guardado ligero de estrategia =====
    function renderSaved(){
      const list = loadJSON(LS_STRATEGIES, []);
      const el = $('#savedList');
      if(!list.length){ el.innerHTML='No hay estrategias guardadas.'; return; }
      el.innerHTML=list.map(x=>`
        <div class="saved-item" style="display:flex;justify-content:space-between;gap:12px;border:1px solid #242a33;background:#0f1117;border-radius:10px;padding:10px;margin:6px 0">
          <div>
            <div class="name" style="font-weight:800; color:white;">${x.name}</div>
            <div class="meta" style="color:#9aa3ad">${new Date(x.ts).toLocaleString()} · Vueltas ${x.laps} · Paradas ${x.stops}</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-load" data-ts="${x.ts}" style="font-size:0.8rem; padding: 5px 10px;">Cargar</button>
            <button class="btn btn-del" data-ts="${x.ts}" style="font-size:0.8rem; padding: 5px 10px; border-color:#ff4444; color:#ff4444;">Borrar</button>
          </div>
        </div>`).join('');
    }
    function loadAll(){ return loadJSON(LS_STRATEGIES, []); }
    function saveAll(list){ saveJSON(LS_STRATEGIES, list); }
    function savePlan(){
      if(!lastStints){ alert('Primero calcula una estrategia antes de guardar.'); return; }
      const item={
        ts:Date.now(),
        name:$('#raceName').value||'Sin nombre',
        laps:$('#kpiLaps').textContent,
        start:$('#kpiStart').textContent,
        stops:$('#kpiAdd').textContent
      };
      const list=loadAll(); list.unshift(item); saveAll(list); renderSaved();
      alert('Estrategia guardada correctamente.');
    }
    function loadByTs(ts){
      const x=loadAll().find(i=>String(i.ts)===String(ts)); if(!x) return;
      $('#raceName').value=x.name;
      alert('Estrategia cargada (nombre). Recalcula para KPIs.');
    }
    function delByTs(ts){ const list=loadAll().filter(i=>String(i.ts)!==String(ts)); saveAll(list); renderSaved(); }

    // ===== Presets coche (incluye tiempos de pit) =====
    function presetMap(){
      try{
        const raw = localStorage.getItem(LS_PRESETS);
        const parsed = raw ? JSON.parse(raw) : {};
        return (parsed && typeof parsed === 'object') ? parsed : {};
      } catch { return {}; }
    }
    function refreshPresetSelect(preserve=true){
      const sel = $('#presetSelect'); if(!sel) return;
      const current = preserve ? sel.value : '';
      const map = presetMap();
      const keys = Object.keys(map);
      sel.innerHTML = keys.length
        ? keys.map(k=>`<option value="${k}">${k}</option>`).join('')
        : '<option value="">(sin presets)</option>';
      if (preserve && current && keys.includes(current)) sel.value = current;
    }
    function collectPreset(){
      return {
        tank: toNum($('#tank').value,0),
        cons: toNum($('#consumption').value,0),
        fillTime: toNum($('#fillTime').value,20),
        wheelTime: toNum($('#wheelTime').value,24)
      };
    }
    function applyPresetToForm(p){
      if(!p) return;
      if(p.tank!=null) $('#tank').value=p.tank;
      if(p.cons!=null) $('#consumption').value=p.cons;
      if(p.fillTime!=null) $('#fillTime').value=p.fillTime;
      if(p.wheelTime!=null) $('#wheelTime').value=p.wheelTime;
    }
    function savePreset(){
      const name=$('#presetName').value.trim();
      if(!name){ alert('Pon un nombre al preset.'); return; }
      try{
        const map = presetMap();
        map[name] = collectPreset();
        saveJSON(LS_PRESETS, map);
        refreshPresetSelect(false);
        $('#presetSelect').value = name;
        $('#presetName').value = name;
        applyPresetToForm(map[name]);
        alert('Preset guardado/actualizado.');
      }catch(e){
        console.error('Error guardando preset', e);
        alert('No se pudo guardar el preset (revisa permisos de almacenamiento).');
      }
    }
    function applyPreset(){
      const name=$('#presetSelect').value;
      if(!name) return;
      const map=presetMap();
      const p = map[name];
      if(!p){ alert('El preset seleccionado no existe.'); refreshPresetSelect(false); return; }
      $('#presetName').value = name;
      applyPresetToForm(p);
    }
    function deletePreset(){
      const name=$('#presetSelect').value;
      if(!name){ alert('Selecciona un preset.'); return; }
      const map=presetMap();
      if(map[name]){ delete map[name]; saveJSON(LS_PRESETS,map); }
      refreshPresetSelect(false);
      $('#presetName').value='';
      alert('Preset borrado.');
    }

    // ===== Export / Import JSON (presets + estrategias) =====
    function exportJSON(){
      const payload = { presets: presetMap(), strategies: loadAll() };
      const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='legacy-fuel-data.json'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},400);
    }
    function importJSON(file){
      const r=new FileReader();
      r.onload=()=>{ try{ const d=JSON.parse(r.result); if(d.presets) saveJSON(LS_PRESETS,d.presets); if(d.strategies) saveJSON(LS_STRATEGIES,d.strategies); refreshPresetSelect(); renderSaved(); alert('Datos importados.'); }catch{ alert('JSON inválido.'); } };
      r.readAsText(file);
    }

    // ===== Eventos =====
    $('#btnCalc').addEventListener('click', compute);
    $('#btnSave').addEventListener('click', savePlan);
    $('#btnExportJSON').addEventListener('click', exportJSON);
    $('#importJSON').addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) importJSON(f); e.target.value=''; });

    $('#btnPresetSave').addEventListener('click', savePreset);
    $('#btnPresetApply').addEventListener('click', applyPreset);
    $('#btnPresetDelete').addEventListener('click', deletePreset);
    $('#presetSelect').addEventListener('change', ()=>{ const n=$('#presetSelect').value; $('#presetName').value=n; applyPreset(); });

    $('#savedList').addEventListener('click', (e)=>{ const t=e.target; if(t.classList.contains('btn-load')) loadByTs(t.getAttribute('data-ts')); if(t.classList.contains('btn-del')) delByTs(t.getAttribute('data-ts')); });

    // Init
    refreshPresetSelect(false);
    renderSaved();
  })();
  </script>
</body>
</html>